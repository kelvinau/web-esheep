const VERSION="0.7.1",ACTIVATE_DEBUG=!1,DEFAULT_XML="http://esheep.petrucci.ch/script/animation.php",COLLISION_WITH=["div","hr"];class DesktopPet{start_esheep(){console.error("Deprecated, use new x=eSheep and x.Start() to start new eSheep.")}}class eSheep{constructor(e){this.animationFile=DEFAULT_XML,this.DOMdiv=document.createElement("div"),this.DOMimg=document.createElement("img"),this.DOMinfo=document.createElement("div"),this.parser=new DOMParser,this.xmlDoc=null,this.isChild=null!=e,this.tilesX=1,this.tilesY=1,this.imageW=1,this.imageH=1,this.imageX=1,this.imageY=1,this.flipped=!1,this.dragging=!1,this.infobox=!1,this.animationId=0,this.animationStep=0,this.animationNode=null,this.sprite=new Image,this.HTMLelement=null,this.randS=100*Math.random(),this.screenW=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.screenH=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}Start(e){void 0!==e&&null!=e&&(this.animationFile=e);var t=new XMLHttpRequest,i=this;t.open("GET",this.animationFile,!0),t.addEventListener("readystatechange",function(){4==this.readyState&&(200==this.status?i._parseXML(this.responseText):console.error("XML not available:"+this.statusText+"\n"+this.responseText))}),t.send(null)}_parseXML(e){this.xmlDoc=this.parser.parseFromString(e,"text/xml");var t=this.xmlDoc.getElementsByTagName("image")[0];this.tilesX=t.getElementsByTagName("tilesx")[0].textContent,this.tilesY=t.getElementsByTagName("tilesy")[0].textContent,this.sprite.addEventListener("load",function(e){ACTIVATE_DEBUG&&console.log("Sprite image loaded");var t="width:"+this.sprite.width+"px;height:"+this.sprite.height+"px;position:absolute;top:0px;left:0px;max-width: none;";this.DOMimg.setAttribute("style",t),this.DOMimg.addEventListener("dragstart",function(e){return e.preventDefault(),!1}),this.imageW=this.sprite.width/this.tilesX,this.imageH=this.sprite.height/this.tilesY,t="width:"+this.imageW+"px;height:"+this.imageH+"px;position:fixed;top:"+this.imageY+"px;left:"+this.imageX+"px;transform:rotatey(0deg);cursor:move;z-index:2000;overflow:hidden;",this.DOMdiv.setAttribute("style",t),this.DOMdiv.appendChild(this.DOMimg),this.isChild?this._spawnChild():this._spawnESheep()}.bind(this)),this.sprite.src="data:image/png;base64,"+t.getElementsByTagName("png")[0].textContent,this.DOMimg.setAttribute("src",this.sprite.src),this.DOMdiv.addEventListener("mousemove",function(e){if(!this.dragging&&1==e.buttons&&0==e.button){this.dragging=!0,this.HTMLelement=null;for(var t=this.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),i=0;i<t.length;i++)if("drag"==t[i].getElementsByTagName("name")[0].textContent){this.animationId=t[i].getAttribute("id"),this.animationStep=0,this.animationNode=t[i];break}}}.bind(this)),document.body.addEventListener("mousemove",function(e){this.dragging&&(this.imageX=parseInt(e.clientX)-this.imageW/2,this.imageY=parseInt(e.clientY)-this.imageH/2,this.DOMdiv.style.left=this.imageX+"px",this.DOMdiv.style.top=this.imageY+"px")}.bind(this)),document.body.addEventListener("resize",function(e){this.screenW=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.screenH=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,this.imageY+this.imageH>this.screenH&&(this.imageY=this.screenH-this.imageH,this.DOMdiv.style.top=this.imageY+"px"),this.imageX+this.imageW>this.screenW&&(this.imageX=this.screenW-this.imageW,this.DOMdiv.style.left=this.imageX+"px")}.bind(this)),this.DOMdiv.addEventListener("contextmenu",function(e){return e.preventDefault(),!1}),this.DOMdiv.addEventListener("mouseup",function(e){this.dragging&&(this.dragging=!1)}.bind(this)),document.body.appendChild(this.DOMdiv)}_setPosition(e,t,i){i?(this.imageX=parseInt(e),this.imageY=parseInt(t)):(this.imageX=parseInt(this.imageX)+parseInt(e),this.imageY=parseInt(this.imageY)+parseInt(t)),this.DOMdiv.style.left=this.imageX+"px",this.DOMdiv.style.top=this.imageY+"px"}_spawnESheep(){for(var e=this.xmlDoc.getElementsByTagName("spawns")[0].getElementsByTagName("spawn"),t=0,i=0;i<e.length;i++)t+=parseInt(e[0].getAttribute("probability"));var a=Math.random()*t;for(t=0,i=0;i<e.length;i++)if((t+=parseInt(e[i].getAttribute("probability")))>=a||i==e.length-1){this._setPosition(this._parseKeyWords(e[i].getElementsByTagName("x")[0].textContent),this._parseKeyWords(e[i].getElementsByTagName("y")[0].textContent),!0),ACTIVATE_DEBUG&&console.log("Spawn: "+this.imageX+", "+this.imageY),this.animationId=e[i].getElementsByTagName("next")[0].textContent,this.animationStep=0;for(var s=this.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),n=0;n<s.length;n++)if(s[n].getAttribute("id")==this.animationId){this.animationNode=s[n];s=this.xmlDoc.getElementsByTagName("childs")[0].getElementsByTagName("child");for(var h=0;h<s.length;h++)if(s[h].getAttribute("animationid")==this.animationId){ACTIVATE_DEBUG&&console.log("Child from Spawn");var m=new eSheep(!0);m.animationId=s[h].getElementsByTagName("next")[0].textContent;var o=s[h].getElementsByTagName("x")[0].textContent,g=s[h].getElementsByTagName("y")[0].textContent;m._setPosition(this._parseKeyWords(o),this._parseKeyWords(g),!0),m.Start(this.animationFile);break}break}break}this._nextESheepStep()}_spawnChild(){for(var e=this.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),t=0;t<e.length;t++)if(e[t].getAttribute("id")==this.animationId){this.animationNode=e[t];break}this._nextESheepStep()}_parseKeyWords(value){value=value.replace(/screenW/g,this.screenW),value=value.replace(/screenH/g,this.screenH),value=value.replace(/areaW/g,this.screenH),value=value.replace(/areaH/g,this.screenH),value=value.replace(/imageW/g,this.imageW),value=value.replace(/imageH/g,this.imageH),value=value.replace(/random/g,100*Math.random()),value=value.replace(/randS/g,this.randS),value=value.replace(/imageX/g,this.imageX),value=value.replace(/imageY/g,this.imageY);var ret=0;try{ret=eval(value)}catch(e){console.error("Unable to parse this position: \n'"+value+"'\n Error message: \n"+e.message)}return ret}_getNextRandomNode(e){var t=e.getElementsByTagName("next"),i=this.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),a=0,s=!1;if(0==t.length)return this.isChild?(ACTIVATE_DEBUG&&console.log("Remove child"),document.body.removeChild(this.DOMinfo),document.body.removeChild(this.DOMdiv)):this._spawnESheep(),!1;for(var n=0;n<t.length;n++)a+=parseInt(t[n].getAttribute("probability"));var h=Math.random()*a,m=0;for(a=0,n=0;n<t.length;n++)if((a+=parseInt(t[n].getAttribute("probability")))>=h){m=n;break}for(n=0;n<i.length;n++)if(i[n].getAttribute("id")==t[m].textContent){this.animationId=i[n].getAttribute("id"),this.animationStep=0,this.animationNode=i[n],s=!0;break}if(s){i=this.xmlDoc.getElementsByTagName("childs")[0].getElementsByTagName("child");for(n=0;n<i.length;n++)if(i[n].getAttribute("animationid")==this.animationId){ACTIVATE_DEBUG&&console.log("Child from Animation");var o=new eSheep(!0);o.animationId=i[n].getElementsByTagName("next")[0].textContent;var g=i[n].getElementsByTagName("x")[0].textContent,r=i[n].getElementsByTagName("y")[0].textContent;o._setPosition(this._parseKeyWords(g),this._parseKeyWords(r),!0),o.Start(this.animationFile);break}}return s}_checkOverlapping(){var e,t=this.imageX,i=this.imageY+this.imageH,a=20;for(var s in this.HTMLelement&&(a=5),COLLISION_WITH)for(var n=document.body.getElementsByTagName(COLLISION_WITH[s]),h=0;h<n.length;h++)if(i>(e=n[h].getBoundingClientRect()).top-2&&i<e.top+a&&t>e.left&&t<e.right-this.imageW){var m=window.getComputedStyle(n[h]);if(""!=m.borderTopStyle&&"none"!=m.borderTopStyle&&"none"!=m.display)return n[h]}return!1}_getNodeValue(e,t,i){if(this.animationNode&&this.animationNode.getElementsByTagName(e)){if(this.animationNode.getElementsByTagName(e)[0].getElementsByTagName(t)[0]){var a=this.animationNode.getElementsByTagName(e)[0].getElementsByTagName(t)[0].textContent;return this._parseKeyWords(a)}return i}}_nextESheepStep(){var e,t=this._getNodeValue("start","x",0),i=this._getNodeValue("start","y",0),a=(this._getNodeValue("start","offsety",0),this._getNodeValue("start","opacity",1),this._getNodeValue("start","interval",1e3)),s=this._getNodeValue("end","x",0),n=this._getNodeValue("end","y",0),h=(this._getNodeValue("end","offsety",0),this._getNodeValue("end","interval",1),this._getNodeValue("end","interval",1e3)),m=this._parseKeyWords(this.animationNode.getElementsByTagName("sequence")[0].getAttribute("repeat")),o=this.animationNode.getElementsByTagName("sequence")[0].getAttribute("repeatfrom"),g=this.animationNode.getElementsByTagName("gravity"),r=this.animationNode.getElementsByTagName("border"),l=this.animationNode.getElementsByTagName("frame").length+(this.animationNode.getElementsByTagName("frame").length-o)*m;if(e=this.animationStep<this.animationNode.getElementsByTagName("frame").length?this.animationNode.getElementsByTagName("frame")[this.animationStep].textContent:0==o?this.animationNode.getElementsByTagName("frame")[this.animationStep%this.animationNode.getElementsByTagName("frame").length].textContent:this.animationNode.getElementsByTagName("frame")[parseInt(o)+parseInt((this.animationStep-o)%(this.animationNode.getElementsByTagName("frame").length-o))].textContent,this.DOMimg.style.left=-this.imageW*(e%this.tilesX)+"px",this.DOMimg.style.top=-this.imageH*parseInt(e/this.tilesX)+"px",this.dragging||this.infobox)return this.animationStep++,void window.setTimeout(function(){this._nextESheepStep()}.bind(this),50);if(this.flipped&&(t=-t,s=-s),0==this.animationStep?this._setPosition(t,i,!1):this._setPosition(parseInt(t)+parseInt((s-t)*this.animationStep/l),parseInt(i)+parseInt((n-i)*this.animationStep/l),!1),this.animationStep++,this.animationStep>=l){if(this.animationNode.getElementsByTagName("action")[0])switch(this.animationNode.getElementsByTagName("action")[0].textContent){case"flip":"rotateY(0deg)"==this.DOMdiv.style.transform?(this.DOMdiv.style.transform="rotateY(180deg)",this.flipped=!0):(this.DOMdiv.style.transform="rotateY(0deg)",this.flipped=!1)}if(!this._getNextRandomNode(this.animationNode.getElementsByTagName("sequence")[0]))return}var d=!1;return r&&r[0]&&r[0].getElementsByTagName("next")&&(s<0&&this.imageX<0?(this.imageX=0,d=!0):s>0&&this.imageX>this.screenW-this.imageW?(this.imageX=this.screenW-this.imageW,this.DOMdiv.style.left=parseInt(this.imageX)+"px",d=!0):n<0&&this.imageY<0?(this.imageY=0,d=!0):n>0&&this.imageY>this.screenH-this.imageH?(this.imageY=this.screenH-this.imageH,d=!0):n>0?this._checkOverlapping()&&this.imageY>this.imageH&&(this.HTMLelement=this._checkOverlapping(),this.imageY=Math.ceil(this.HTMLelement.getBoundingClientRect().top)-this.imageH,d=!0):this.HTMLelement&&(this._checkOverlapping()||(this.imageY+this.imageH>this.HTMLelement.getBoundingClientRect().top+3||this.imageY+this.imageH<this.HTMLelement.getBoundingClientRect().top-3?this.HTMLelement=null:this.imageX<this.HTMLelement.getBoundingClientRect().left?(this.imageX=parseInt(this.imageX+3),d=!0):(this.imageX=parseInt(this.imageX-3),d=!0),this.DOMdiv.style.left=parseInt(this.imageX)+"px")),d&&!this._getNextRandomNode(r[0]))||!d&&g&&g[0]&&g[0].getElementsByTagName("next")&&this.imageY<this.screenH-this.imageH-2&&(null==this.HTMLelement?d=!0:this._checkOverlapping()||(d=!0,this.HTMLelement=null),d&&!this._getNextRandomNode(g[0]))?void 0:!d&&(this.imageX<-this.imageW&&s<0||this.imageX>this.screenW&&s>0||this.imageY<-this.imageH&&i<0||this.imageY>this.screenH&&n>0)?(d=!0,void(this.isChild||this._spawnESheep())):void window.setTimeout(function(){this._nextESheepStep()}.bind(this),parseInt(a)+parseInt((h-a)*this.animationStep/l))}}